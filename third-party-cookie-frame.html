<html>

<body>
    <button id="request-access">Start hasStorageAccess/requestStorageAccess flow</button>
    <button id="add-to-ls">Add random value to localStorage handle</button>
    <div id="ls-last-check-timestamp"></div>
    <div id="has-storage-access"></div>
    <div>
        localStorage data:
    </div>
    <div id="ls-box" style="white-space: pre;"></div>
    <script>
        const lsLastCheckTimestamp = document.getElementById('ls-last-check-timestamp');
        const hasStorageAccess = document.getElementById('has-storage-access');
        const requestAccessBtn = document.getElementById('request-access');
        const addToLSBtn = document.getElementById('add-to-ls');
        const lsBox = document.getElementById('ls-box');

        let lsHandle;

        window.setInterval(() => {
            lsLastCheckTimestamp.innerText = `Last checked: ${new Date().toLocaleTimeString()}`;
            document.hasStorageAccess().then(result => {
                hasStorageAccess.innerText = `Has storage access: ${result}`;
            });

            if(!lsHandle) return;

            const ls = lsHandle.localStorage;

            lsBox.innerText = JSON.stringify(Object.keys(ls).reduce((acc, key) => {
                acc[key] = ls[key];
                return acc;
            }, {}), null, 4);
        }, 1000);

        requestAccessBtn.addEventListener('click', async () => {
            const hasAccess = await document.hasStorageAccess();
            console.log('hasStorageAccess returned as', hasAccess);

            if(!hasAccess) {
                lsHandle = await document.requestStorageAccess({ all: true });
            } else {
                lsHandle = window;
            }
        });

        addToLSBtn.addEventListener('click', () => {
            if(!lsHandle) return;

            lsHandle.localStorage.setItem(`key-${Math.random()}`, Math.random());
        });
    </script>
</body>

</html>