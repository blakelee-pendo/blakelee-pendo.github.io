<html>

<body>
    <button id="has-slash-request">use hasStorageAccess/requestStorageAccess flow, generate new handle and write to it</button>
    <button id="always-request">always rely on requestStorageAccess return value</button>
    <div id="ls-last-check-timestamp"></div>
    <div id="has-storage-access"></div>
    <div id="ls-box"></div>
    <script>
        const lsLastCheckTimestamp = document.getElementById('ls-last-check-timestamp');
        const hasStorageAccess = document.getElementById('has-storage-access');
        const hasSlashRequestBtn = document.getElementById('has-slash-request');
        const addToLSBtn = document.getElementById('add-to-ls');
        const alwaysRequestBtn = document.getElementById('always-request');
        const lsBox = document.getElementById('ls-box');

        const storageInstances = [{
            label: 'window.localStorage',
            handle: window
        }];

        lsBox.innerHTML = lsBox.innerHTML + `
            <div>
                ${storageInstances[0].label}
            </div>
            <div id="ls-handle-${storageInstances.length}" style="white-space: pre;"></div>
        `;

        window.setInterval(() => {
            lsLastCheckTimestamp.innerText = `Last checked: ${new Date().toLocaleTimeString()}`;
            document.hasStorageAccess().then(result => {
                hasStorageAccess.innerText = `Has storage access: ${result}`;
            });

            if(!storageInstances.length) return;

            storageInstances.forEach((storageInstance, index) => {
                const lsBox = document.getElementById(`ls-handle-${index + 1}`);
                const ls = storageInstance.localStorage;

                lsBox.innerText = JSON.stringify(Object.keys(ls).reduce((acc, key) => {
                    acc[key] = ls[key];
                    return acc;
                }, {}), null, 4);
            });
        }, 1000);

        hasSlashRequestBtn.addEventListener('click', async () => {
            const hasAccess = await document.hasStorageAccess();
            const newStorageInstance = {}

            if(!hasAccess) {
                const newHandle = await document.requestStorageAccess({ all: true });
                newStorageInstance.label = `(${storageInstances.length + 1}) requestStorageAccess({ all: true }) handle`;
                newStorageInstance.handle = newHandle;
            } else {
                const newHandle = window;
                newStorageInstance.label = `(${storageInstances.length + 1}) window handle`;
                newStorageInstance.handle = newHandle;
            }

            storageInstances.push(newStorageInstance);

            newHandle.localStorage.setItem(`storage-instance-${storageInstances.length}`, `value-${storageInstances.length}`);

            lsBox.innerHTML = lsBox.innerHTML + `
                <div>
                    ${newStorageInstance.label}
                </div>
                <div id="ls-handle-${storageInstances.length}" style="white-space: pre;"></div>
            `;
        });

        alwaysRequestBtn.addEventListener('click', async () => {
            const newHandle = await document.requestStorageAccess({ all: true });
            const newStorageInstance = {
                label: `(${storageInstances.length + 1}) requestStorageAccess({ all: true }) handle`,
                handle: newHandle
            };

            storageInstances.push(newStorageInstance);

            newHandle.localStorage.setItem(`storage-instance-${storageInstances.length}`, `value-${storageInstances.length}`);

            lsBox.innerHTML = lsBox.innerHTML + `
                <div>
                    ${newStorageInstance.label}
                </div>
                <div id="ls-handle-${storageInstances.length}" style="white-space: pre;"></div>
            `;
        });
    </script>
</body>

</html>